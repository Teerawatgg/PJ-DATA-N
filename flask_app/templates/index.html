<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Olist E-Commerce Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: linear-gradient(135deg, #0f172a, #1f2937);
      --card: rgba(255,255,255,0.96);
      --muted: #6b7280;
      --shadow: 0 16px 34px rgba(0,0,0,0.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:24px;
      font-family: Arial, sans-serif;
      background: var(--bg);
      min-height:100vh;
    }
    .container{ max-width:1200px; margin:0 auto; }
    .header{
      background: rgba(255,255,255,0.10);
      color:#f9fafb;
      padding:18px 20px;
      border-radius: 22px;
      box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-bottom:18px;
    }
    .header h1{ margin:0; font-size:20px; }
    .subtitle{ margin:0; opacity:0.9; font-size:12px; }
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-bottom:14px;
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding:16px 18px;
      box-shadow: 0 10px 26px rgba(15,23,42,0.35);
    }
    .label{ color: var(--muted); font-size:12px; }
    .value{ font-size:24px; font-weight:800; margin-top:6px; }
    .section{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:12px;
    }
    .panel{
      background: var(--card);
      border-radius: var(--radius);
      padding:16px 18px;
      box-shadow: 0 10px 26px rgba(15,23,42,0.35);
    }
    .panel.full{ grid-column: 1 / -1; }
    .panel h2{ margin:0 0 8px; font-size:16px; }
    .panel p{ margin:0 0 12px; color: var(--muted); font-size:12px; }
    .chart-wrap{ height:320px; }
    canvas{ width:100% !important; height:100% !important; }

    table{ width:100%; border-collapse:collapse; font-size:13px; margin-top:10px; }
    th,td{ padding:10px; border-bottom:1px solid #e5e7eb; text-align:left; }
    th{ background:#f3f4f6; }
    .pill{ padding:4px 10px; border-radius:999px; background:rgba(59,130,246,0.12); color:#1d4ed8; font-weight:700; font-size:12px; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .section{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <div>
      <h1>üõí Olist E-Commerce Dashboard</h1>
      <p class="subtitle">Source: dm.v_kpi_* (Star Schema) ‚Üí For Advanced SQL & Web Dashboard</p>
    </div>
    <div class="subtitle">Flask + Postgres + Chart.js</div>
  </div>

  <!-- Summary cards -->
  <div class="grid">
    <div class="card">
      <div class="label">Total Orders</div>
      <div class="value">{{ "{:,}".format(summary.total_orders or 0) }}</div>
    </div>
    <div class="card">
      <div class="label">Total GMV</div>
      <div class="value">{{ "{:,.2f}".format(summary.total_gmv or 0) }}</div>
    </div>
    <div class="card">
      <div class="label">Avg Review</div>
      <div class="value">{{ "{:.2f}".format(summary.avg_review or 0) }}</div>
    </div>
  </div>

  <div class="section">
    <div class="panel full">
      <h2>GMV & Orders by Month</h2>
      <p>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (GMV) ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
      <div class="chart-wrap"><canvas id="monthlyChart"></canvas></div>
    </div>

    <div class="panel">
      <h2>Sales by Customer State (Top 15)</h2>
      <p>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏ê/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (state) ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
      <div class="chart-wrap"><canvas id="stateChart"></canvas></div>

      <table>
        <thead>
          <tr><th>State</th><th>Orders</th><th>GMV</th></tr>
        </thead>
        <tbody>
        {% for r in top_states %}
          <tr>
            <td><span class="pill">{{ r.customer_state }}</span></td>
            <td>{{ "{:,}".format(r.orders or 0) }}</td>
            <td>{{ "{:,.2f}".format(r.gmv or 0) }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="panel">
      <h2>Top Categories (by Revenue)</h2>
      <p>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
      <div class="chart-wrap"><canvas id="catChart"></canvas></div>

      <table>
        <thead>
          <tr><th>Category</th><th>Items</th><th>Revenue</th></tr>
        </thead>
        <tbody>
        {% for r in top_categories %}
          <tr>
            <td>{{ r.category }}</td>
            <td>{{ "{:,}".format(r.items_sold or 0) }}</td>
            <td>{{ "{:,.2f}".format(r.revenue_items or 0) }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="panel">
      <h2>Payment Mix</h2>
      <p>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</p>
      <div class="chart-wrap"><canvas id="payChart"></canvas></div>
    </div>

    <div class="panel">
      <h2>Delivery SLA</h2>
      <p>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‚Äú‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤/‡πÄ‡∏£‡πá‡∏ß‚Äù ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏Ñ‡πà‡∏≤‡∏ö‡∏ß‡∏Å = ‡∏ä‡πâ‡∏≤, ‡∏Ñ‡πà‡∏≤‡∏•‡∏ö = ‡πÄ‡∏£‡πá‡∏ß)</p>
      <div class="chart-wrap"><canvas id="slaChart"></canvas></div>
    </div>
  </div>
</div>

<script>
  const fmtMoney = (n) => {
    const x = Number(n || 0);
    return x.toLocaleString(undefined, {maximumFractionDigits: 2});
  };

  async function fetchJson(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  // 1) Monthly GMV + Orders (2 axis)
  async function loadMonthly(){
    const data = await fetchJson("/api/monthly");
    const ctx = document.getElementById("monthlyChart");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.labels,
        datasets: [
          { label: "GMV", data: data.gmv, yAxisID: "y1" },
          { label: "Orders", data: data.orders, type:"line", yAxisID: "y2" }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:"index", intersect:false },
        scales:{
          y1: { position:"left", ticks:{ callback:(v)=>fmtMoney(v) } },
          y2: { position:"right", grid:{ drawOnChartArea:false } }
        }
      }
    });
  }

  // 2) Sales by State
  async function loadState(){
    const data = await fetchJson("/api/sales_by_state");
    const ctx = document.getElementById("stateChart");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.labels,
        datasets: [
          { label: "GMV", data: data.gmv }
        ]
      },
      options: {
        indexAxis: "y",
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:true } },
        scales:{ x:{ ticks:{ callback:(v)=>fmtMoney(v) } } }
      }
    });
  }

  // 3) Top categories revenue
  async function loadCategories(){
    const data = await fetchJson("/api/top_categories");
    const ctx = document.getElementById("catChart");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.labels,
        datasets: [
          { label: "Revenue (items)", data: data.revenue }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        scales:{ y:{ ticks:{ callback:(v)=>fmtMoney(v) } } }
      }
    });
  }

  // 4) Payment mix
  async function loadPayment(){
    const data = await fetchJson("/api/payment_mix");
    const ctx = document.getElementById("payChart");
    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: data.labels,
        datasets: [{ label:"Total Paid", data: data.total_paid }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false
      }
    });
  }

  // 5) SLA avg days late
  async function loadSLA(){
    const data = await fetchJson("/api/sla");
    const ctx = document.getElementById("slaChart");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: data.labels,
        datasets: [{ label:"Avg Days Late", data: data.avg_days_late }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false
      }
    });
  }

  Promise.all([loadMonthly(), loadState(), loadCategories(), loadPayment(), loadSLA()])
    .catch(err => console.error("Dashboard load error:", err));
</script>
</body>
</html>